#!/bin/bash
#
# This script creates the benchmark application in this directory.


BSP_DIR=../../bsp/ucosii_net_tse_zipfs

QUARTUS_PROJECT_DIR=../../../
NIOS2_APP_GEN_ARGS="--elf-name benchmark.elf --set OBJDUMP_INCLUDE_SOURCE 1 --src-dir ."


# First, check to see if $SOPC_KIT_NIOS2 environmental variable is set.
# This variable is required for the command line tools to execute correctly.
if [ -z $SOPC_KIT_NIOS2 ]
then
    echo Required \$SOPC_KIT_NIOS2 Environmental Variable is not set!
    exit 1
fi


# Also make sure that the APP has not been created already.  Check for
# existence of Makefile in the app directory
if [ -f ./Makefile ]
then
    echo Application has already been created!  Delete Makefile if you want to create a new application makefile
    exit 1
fi


# We are selecting ucosii_net_tse_zipfs bsp because it supports this application.

# Check to see if the ucosii_net_tse_zipfs has already been generated by checking for 

# existence of the public.mk file.  If not, we need to run
# create-this-bsp file to generate the bsp.
if [ ! -f $BSP_DIR/public.mk ]; then
    # Since BSP doesn't exist, create the BSP
    # Pass any command line arguments passed to this script to the BSP.
    pushd $BSP_DIR >> /dev/null
    ./create-this-bsp "$@" || {
    	echo "create-this-bsp failed"
    	exit 1
    }
    popd >> /dev/null
fi


# Don't run make if create-this-app script is called with --no-make arg
SKIP_MAKE=
while [ $# -gt 0 ]
do
  case "$1" in
      --no-make)
          SKIP_MAKE=1
          ;;
  esac
  shift
done


cmd="nios2-app-generate-makefile --bsp-dir $BSP_DIR --set QUARTUS_PROJECT_DIR=$QUARTUS_PROJECT_DIR $NIOS2_APP_GEN_ARGS"

echo "create-this-app: Running \"$cmd\""
$cmd || {
    echo "nios2-app-generate-makefile failed"
    exit 1
}

if [ -z "$SKIP_MAKE" ]; then
	cmd="make"

	echo "create-this-app: Running \"$cmd\""
	$cmd || {
    	echo "make failed"
	    exit 1
	}

	echo
	echo "To download and run the application:"
	echo "    1. Make sure the board is connected to the system."
	echo "    2. Run 'nios2-configure-sof -C ../../..' to configure the FPGA with the hardware design."
	echo "    3. Run 'nios2-download -g *.elf && nios2-terminal' to run the software and open a Nios II terminal to display output."
	echo
	echo "To debug the application:"
	echo -e "    Import the project into Nios II Software Build Tools for Eclipse (STBE).  Refer to Nios II SBTE Documentation for more information."
fi


exit 0
